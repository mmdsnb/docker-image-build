# å¼€å‘å®¹å™¨ Dockerfile
# åŸºäºŽ Ubuntu 22.04 LTS çš„ Docker-in-Docker å…¨æ ˆå¼€å‘çŽ¯å¢ƒ

FROM ubuntu:22.04

# é¿å…äº¤äº’å¼å®‰è£…æç¤º
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Shanghai \
    # å·¥å…·ç‰ˆæœ¬å®šä¹‰
    DOCKER_COMPOSE_VERSION=v2.24.0 \
    NVM_VERSION=v0.39.7 \
    # ç›®å½•å®šä¹‰
    NVM_DIR=/root/.nvm \
    SDKMAN_DIR=/root/.sdkman

# ============================================
# é˜¶æ®µ 1: ç³»ç»ŸåŸºç¡€é…ç½®
# ============================================

# é…ç½®é˜¿é‡Œäº‘é•œåƒæºï¼ˆå¤šæž¶æž„è‡ªåŠ¨é€‚é…ï¼‰
RUN cp /etc/apt/sources.list /etc/apt/sources.list.backup && \
    ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "amd64" ] || [ "$ARCH" = "i386" ]; then \
        UBUNTU_REPO="ubuntu"; \
    else \
        UBUNTU_REPO="ubuntu-ports"; \
    fi && \
    echo "æ£€æµ‹åˆ°æž¶æž„: $ARCH, ä½¿ç”¨æº: $UBUNTU_REPO" && \
    cat > /etc/apt/sources.list <<EOF
deb http://mirrors.aliyun.com/$UBUNTU_REPO/ jammy main restricted universe multiverse
deb http://mirrors.aliyun.com/$UBUNTU_REPO/ jammy-security main restricted universe multiverse
deb http://mirrors.aliyun.com/$UBUNTU_REPO/ jammy-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/$UBUNTU_REPO/ jammy-backports main restricted universe multiverse
EOF

# ============================================
# é˜¶æ®µ 2: å®‰è£…ç³»ç»ŸåŒ…å’ŒåŸºç¡€å·¥å…·
# ============================================

RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y \
        # åŸºç¡€å·¥å…·
        curl \
        wget \
        zip \
        unzip \
        tar \
        vim \
        git \
        build-essential \
        make \
        software-properties-common \
        ca-certificates \
        gnupg \
        lsb-release \
        # ç½‘ç»œå·¥å…·
        net-tools \
        iputils-ping \
        telnet \
        netcat-openbsd \
        # ç³»ç»Ÿç›‘æŽ§
        htop \
        procps \
        # JSON å¤„ç†
        jq \
        # Python å¼€å‘
        python3-pip \
        python3-dev \
        # SSH æœåŠ¡
        openssh-server \
        # Shell
        zsh && \
    # æ¸…ç†ç¼“å­˜
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ============================================
# é˜¶æ®µ 3: å®‰è£… Docker å’Œ Docker Compose
# ============================================

# å®‰è£… Dockerï¼ˆä½¿ç”¨å®˜æ–¹è„šæœ¬ï¼‰
RUN curl -fsSL https://get.docker.com | sh

# å®‰è£… Docker Composeï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
        COMPOSE_ARCH="x86_64"; \
    elif [ "$ARCH" = "aarch64" ]; then \
        COMPOSE_ARCH="aarch64"; \
    else \
        COMPOSE_ARCH=$ARCH; \
    fi && \
    curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-linux-${COMPOSE_ARCH}" \
        -o /usr/local/bin/docker-compose && \
    chmod +x /usr/local/bin/docker-compose && \
    docker-compose --version

# ============================================
# é˜¶æ®µ 4: é…ç½® Python çŽ¯å¢ƒ
# ============================================

# åˆ›å»º python è½¯é“¾æŽ¥
RUN ln -sf /usr/bin/python3 /usr/bin/python && \
    python --version

# é…ç½® pip é•œåƒæº
RUN mkdir -p /root/.pip && \
    cat > /root/.pip/pip.conf <<'EOF'
[global]
index-url = http://mirrors.aliyun.com/pypi/simple/
trusted-host = mirrors.aliyun.com
EOF

# å®‰è£… uvï¼ˆçŽ°ä»£ Python åŒ…ç®¡ç†å™¨ï¼‰
RUN pip3 install --no-cache-dir uv && \
    uv --version

# é…ç½® uv é•œåƒæº
RUN mkdir -p /root/.config/uv && \
    cat > /root/.config/uv/uv.toml <<'EOF'
[index]
url = "http://mirrors.aliyun.com/pypi/simple/"

[[index.trusted-host]]
host = "mirrors.aliyun.com"
EOF

# ============================================
# é˜¶æ®µ 5: å®‰è£… Node.js å’Œ Java ç‰ˆæœ¬ç®¡ç†å™¨
# ============================================

# å®‰è£… nvmï¼ˆNode.js ç‰ˆæœ¬ç®¡ç†å™¨ï¼‰
RUN curl -o- "https://raw.githubusercontent.com/nvm-sh/nvm/${NVM_VERSION}/install.sh" | bash && \
    # éªŒè¯å®‰è£…
    . "$NVM_DIR/nvm.sh" && nvm --version

# å®‰è£… SDKMANï¼ˆJava/JVM å·¥å…·ç‰ˆæœ¬ç®¡ç†å™¨ï¼‰
RUN curl -s "https://get.sdkman.io" | bash && \
    # éªŒè¯å®‰è£…
    bash -c "source $SDKMAN_DIR/bin/sdkman-init.sh && sdk version"

# ============================================
# é˜¶æ®µ 6: é…ç½® Zsh å’Œ Oh My Zsh
# ============================================

# è®¾ç½® zsh ä¸ºé»˜è®¤ shell
RUN chsh -s /usr/bin/zsh root

# å®‰è£… Oh My Zsh
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

# å®‰è£… zsh æ’ä»¶
RUN git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions \
        ${ZSH_CUSTOM:-/root/.oh-my-zsh/custom}/plugins/zsh-autosuggestions && \
    git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting \
        ${ZSH_CUSTOM:-/root/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting

# é…ç½® Oh My Zsh æ’ä»¶
RUN sed -i 's/plugins=(git)/plugins=(git docker docker-compose python pip extract z colored-man-pages command-not-found zsh-autosuggestions zsh-syntax-highlighting)/g' /root/.zshrc

# é…ç½® zsh çŽ¯å¢ƒå˜é‡
RUN cat >> /root/.zshrc <<'EOF'

# ============================================
# å¼€å‘çŽ¯å¢ƒé…ç½®
# ============================================

# NVMï¼ˆNode.js ç‰ˆæœ¬ç®¡ç†ï¼‰
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

# SDKMANï¼ˆJVM å·¥å…·ç‰ˆæœ¬ç®¡ç†ï¼‰
export SDKMAN_DIR="/root/.sdkman"
[[ -s "/root/.sdkman/bin/sdkman-init.sh" ]] && source "/root/.sdkman/bin/sdkman-init.sh"

# Python uv å·¥å…·
export PATH="$HOME/.local/bin:$PATH"

# Docker åˆ«å
alias d='docker'
alias dc='docker-compose'
alias dps='docker ps'
alias di='docker images'

# å¸¸ç”¨åˆ«å
alias ll='ls -lah'
alias ..='cd ..'
alias ...='cd ../..'

# æ¬¢è¿Žä¿¡æ¯
echo "ðŸš€ å¼€å‘çŽ¯å¢ƒå·²å°±ç»ªï¼"
echo "ðŸ“¦ Docker: $(docker --version 2>/dev/null || echo 'Not running')"
echo "ðŸ Python: $(python --version 2>/dev/null || echo 'N/A')"
echo "ðŸ“Š å¯ç”¨å‘½ä»¤: d (docker), dc (docker-compose), uv (python)"
EOF

# ============================================
# é˜¶æ®µ 7: é…ç½® SSH æœåŠ¡
# ============================================

RUN mkdir -p /var/run/sshd /root/.ssh && \
    chmod 700 /root/.ssh && \
    # ç”Ÿæˆ SSH å¯†é’¥
    ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -N "" -C "devcontainer" && \
    ssh-keygen -t rsa -b 4096 -f /root/.ssh/id_rsa -N "" -C "devcontainer-rsa" && \
    # åˆ›å»º authorized_keys
    touch /root/.ssh/authorized_keys && \
    chmod 600 /root/.ssh/authorized_keys && \
    # é…ç½® SSH æœåŠ¡ï¼ˆå®‰å…¨é…ç½®ï¼‰
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config && \
    sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#AuthorizedKeysFile/AuthorizedKeysFile/' /etc/ssh/sshd_config && \
    # ç¦ç”¨å¯†ç ç™»å½•ï¼Œåªå…è®¸å¯†é’¥è®¤è¯
    echo "PasswordAuthentication no" >> /etc/ssh/sshd_config && \
    echo "ChallengeResponseAuthentication no" >> /etc/ssh/sshd_config

# é…ç½® SSH å®¢æˆ·ç«¯ï¼ˆGit ä½¿ç”¨ï¼‰
RUN cat > /root/.ssh/config <<'EOF'
Host *
    StrictHostKeyChecking accept-new
    ServerAliveInterval 60
    ServerAliveCountMax 3
EOF

RUN chmod 600 /root/.ssh/config

# ============================================
# é˜¶æ®µ 8: å®‰è£… VSCode CLI (æ”¯æŒ Tunnel)
# ============================================

# å®‰è£… VSCode CLIï¼ˆæ”¯æŒè¿œç¨‹éš§é“è¿žæŽ¥ï¼‰
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
        VSCODE_ARCH="x64"; \
    elif [ "$ARCH" = "aarch64" ]; then \
        VSCODE_ARCH="arm64"; \
    else \
        echo "ä¸æ”¯æŒçš„æž¶æž„: $ARCH" && exit 1; \
    fi && \
    echo "ä¸‹è½½ VSCode CLI for ${VSCODE_ARCH}..." && \
    curl -fSL "https://code.visualstudio.com/sha/download?build=stable&os=cli-alpine-${VSCODE_ARCH}" \
        --output /tmp/vscode-cli.tar.gz && \
    tar -xzf /tmp/vscode-cli.tar.gz -C /usr/local/bin && \
    rm /tmp/vscode-cli.tar.gz && \
    code --version && \
    echo "âœ… VSCode CLI å®‰è£…æˆåŠŸ"

# ============================================
# é˜¶æ®µ 9: æœ€ç»ˆé…ç½®
# ============================================

# åˆ›å»ºå·¥ä½œç›®å½•
RUN mkdir -p /workspace

# é…ç½® Git
RUN git config --global init.defaultBranch main && \
    git config --global pull.rebase false && \
    git config --global core.editor vim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /workspace

# æš´éœ²ç«¯å£
# 22: SSH
# 3000: React/Next.js ç­‰å‰ç«¯å¼€å‘
# 8000: Python/Django ç­‰åŽç«¯å¼€å‘
# 8080: é€šç”¨ HTTP
# 9000: å…¶ä»–æœåŠ¡
EXPOSE 22 3000 8000 8080 9000

# é»˜è®¤å¯åŠ¨ zsh shell
CMD ["/usr/bin/zsh"]
