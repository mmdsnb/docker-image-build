name: Build and Push Docker Image

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'è¾“å…¥è¦æ„å»ºçš„é•œåƒåç§°ï¼ˆå¦‚ï¼šhelloworldï¼‰'
        required: true
        type: string
        default: 'helloworld'

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯é•œåƒç›®å½•
        run: |
          if [ ! -d "${{ inputs.image_name }}" ]; then
            echo "âŒ é”™è¯¯: ç›®å½• '${{ inputs.image_name }}' ä¸å­˜åœ¨"
            echo "ğŸ“ å¯ç”¨çš„é•œåƒç›®å½•ï¼š"
            find . -maxdepth 2 -name "Dockerfile" -exec dirname {} \; | sed 's|./||' | sort
            exit 1
          fi
          if [ ! -f "${{ inputs.image_name }}/Dockerfile" ]; then
            echo "âŒ é”™è¯¯: ç›®å½• '${{ inputs.image_name }}' ä¸­æ²¡æœ‰ Dockerfile"
            exit 1
          fi
          echo "âœ… éªŒè¯é€šè¿‡: ${{ inputs.image_name }}/Dockerfile å­˜åœ¨"

      - name: è®¾ç½® QEMUï¼ˆå¤šå¹³å°æ”¯æŒï¼‰
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./${{ inputs.image_name }}
          file: ./${{ inputs.image_name }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${{ inputs.image_name }}:latest
            registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${{ inputs.image_name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: æ„å»ºå®Œæˆ
        run: |
          echo "âœ… é•œåƒæ„å»ºæˆåŠŸï¼"
          echo "ğŸ“¦ é•œåƒåç§°: ${{ inputs.image_name }}"
          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: latest, ${{ github.sha }}"
          echo "ğŸš€ æ¨é€åœ°å€: registry.cn-hangzhou.aliyuncs.com/${{ secrets.ALIYUN_NAMESPACE }}/${{ inputs.image_name }}"
